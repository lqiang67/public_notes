#!/bin/bash

# publish_notes - Script to publish notes to GitHub
# Usage: publish_notes <foldername>
# The folder can be anywhere on the system

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the script directory (where publish_notes is located)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
NOTES_DIR="$SCRIPT_DIR/notes"

# Check if folder name is provided
if [ $# -eq 0 ]; then
    echo -e "${RED}Error: Please provide a folder name or path${NC}"
    echo "Usage: publish_notes <foldername_or_path>"
    exit 1
fi

SOURCE_FOLDER="$1"

# Resolve absolute path if relative path is provided
if [ ! -d "$SOURCE_FOLDER" ]; then
    echo -e "${RED}Error: Folder '$SOURCE_FOLDER' does not exist${NC}"
    exit 1
fi

# Get absolute path (handles both relative and absolute paths)
if [[ "$SOURCE_FOLDER" != /* ]]; then
    # Relative path - convert to absolute
    SOURCE_FOLDER=$(cd "$(dirname "$SOURCE_FOLDER")" && pwd)/$(basename "$SOURCE_FOLDER")
else
    # Already absolute path - just normalize it
    SOURCE_FOLDER=$(cd "$(dirname "$SOURCE_FOLDER")" && pwd)/$(basename "$SOURCE_FOLDER")
fi
FOLDER_NAME=$(basename "$SOURCE_FOLDER")
TARGET_DIR="$NOTES_DIR/$FOLDER_NAME"

echo -e "${GREEN}Publishing notes: $FOLDER_NAME${NC}"

# Create notes directory if it doesn't exist
mkdir -p "$NOTES_DIR"

# Copy the folder
echo "Copying folder to $TARGET_DIR..."
if [ -d "$TARGET_DIR" ]; then
    echo -e "${YELLOW}Warning: Folder already exists. Overwriting...${NC}"
    rm -rf "$TARGET_DIR"
fi
cp -r "$SOURCE_FOLDER" "$TARGET_DIR"

# Update README.md
echo "Updating README.md..."
"$SCRIPT_DIR/update_readme.sh"

# Check if git is initialized
if [ ! -d "$SCRIPT_DIR/.git" ]; then
    echo -e "${YELLOW}Git repository not initialized. Run setup_repo.sh first.${NC}"
    exit 1
fi

# Add changes to git
cd "$SCRIPT_DIR"
git add notes/
git add README.md

# Check if there are changes to commit
if git diff --staged --quiet; then
    echo -e "${YELLOW}No changes to commit.${NC}"
else
    # Commit changes
    COMMIT_MSG="Publish notes: $FOLDER_NAME"
    git commit -m "$COMMIT_MSG"
    echo -e "${GREEN}Committed changes${NC}"
    
    # Push to GitHub
    echo "Pushing to GitHub..."
    git push origin main 2>/dev/null || git push origin master 2>/dev/null || {
        echo -e "${YELLOW}Warning: Could not push to GitHub. You may need to set up the remote.${NC}"
        echo "Run: git remote add origin https://github.com/lqiang67/public_notes.git"
        echo "Or check your git configuration."
    }
fi

echo -e "${GREEN}Done! Notes published successfully.${NC}"

